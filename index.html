<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Excelence â€” Employee Data Management</title>
  <meta name="description" content="Upload, edit and export employee data. Works offline and can be shared via QR or public URL.">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- QR generator (client-side) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
  <div class="app">
    <header class="app-header">
      <div class="brand">
        <div class="brand-text">
          <div class="brand-title">Excelence</div>
          <div class="brand-sub">Employee Data Management</div>
        </div>
      </div>
      <div class="header-actions">
      </div>
    </header>

  <div class="container">
    
    
    <div class="file-controls">
      <input type="file" id="excelFile" accept=".xlsx,.xls" class="file-input" />
      <label for="excelFile" class="file-label">Choose Excel File</label>
      <button id="saveExcel" class="action-button">Save to Excel</button>
    </div>

    <form id="dataForm" class="data-form">
      <div class="form-group">
        <label class="form-label" for="Master">Master</label>
        <input type="text" id="Master" class="form-control" required />
      </div>
      <div class="form-group">
        <label class="form-label" for="Employment Status">Employment Status</label>
        <input type="text" id="Employment Status" class="form-control" required />
      </div>
      <div class="form-group">
        <label class="form-label" for="Emp code">Employee Code</label>
        <input type="text" id="Emp code" class="form-control" required />
      </div>
      <div class="form-group">
        <label class="form-label" for="Name">Name</label>
        <input type="text" id="Name" class="form-control" required />
      </div>
      <div class="form-group">
        <label class="form-label" for="Designation">Designation</label>
        <input type="text" id="Designation" class="form-control" required />
      </div>
      <div class="form-group">
        <label class="form-label" for="Department">Department</label>
        <input type="text" id="Department" class="form-control" required />
      </div>
      <div class="form-group">
        <label class="form-label" for="SMU(internal use)">SMU(Internal Use)</label>
        <input type="text" id="SMU(internal use)" class="form-control" required />
      </div>
      <div class="form-group">
        <label class="form-label" for="BU">Business Unit</label>
        <input type="text" id="BU" class="form-control" required />
      </div>
      <div class="form-group">
        <label class="form-label" for="Gender">Gender</label>
        <input type="text" id="Gender" class="form-control" required />
      </div>
      <div class="form-group">
        <label class="form-label" for="Work Shift">Work Shift</label>
        <input type="text" id="Work Shift" class="form-control" required />
      </div>
      <div class="form-group">
        <label class="form-label" for="HR Advisor">HR Advisor</label>
        <input type="text" id="HR Advisor" class="form-control" required />
      </div>
      <div class="form-group">
        <label class="form-label" for="New HR Advisor">New HR Advisor</label>
        <input type="text" id="New HR Advisor" class="form-control" required />
      </div>
      <div class="form-group">
        <label class="form-label" for="Location">Location</label>
        <input type="text" id="Location" class="form-control" required />
      </div>
      <button type="submit" class="submit-btn">Add Entry</button>
    </form>

    <div class="table-toolbar">
      <div class="left">
        <input id="tableSearch" class="form-control" placeholder="Search name, code, department..." style="min-width:220px;" />
        <button id="clearData" class="file-label small">Clear Data</button>
      </div>
      <div class="right">
        <button id="exportCsv" class="action-button small">Export CSV</button>
      </div>
    </div>

    <table id="dataTable" class="data-table">
    <thead>
      <tr>
        <th>Master</th>
        <th>Employment Status</th>
        <th>Emp code</th>
        <th>Name</th>
        <th>Designation</th>
        <th>Department</th>
        <th>SMU(internal use)</th>
        <th>Business Unit</th>
        <th>Gender</th>
        <th>Work Shift</th>
        <th>HR Advisor</th>
        <th>New HR Advisor</th>
        <th>Location</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
  let dataEntries = JSON.parse(localStorage.getItem('excelenceData')) || [];
    let uploadedWorkbook = null;
    let uploadedFilename = null;

    function getEffectiveShareUrl() {
      const input = document.getElementById('shareUrl');
      const val = input && input.value && input.value.trim();
      if (val) return val;
   
      try {
        const u = new URL(window.location.href);
        if (u.protocol === 'file:') return window.location.href;
        return u.origin + u.pathname.replace(/index\.html$/,'');
      } catch (e) {
        return window.location.href;
      }
    }

    document.addEventListener('DOMContentLoaded', function() {
      const input = document.getElementById('shareUrl');
      if (input) input.value = '';

      const qrEl = document.getElementById('qrCode');
      const meta = document.getElementById('shareMeta');

      document.getElementById('generateQr').addEventListener('click', function() {
        const url = getEffectiveShareUrl();
        if (!url) return;
        qrEl.innerHTML = '';
        try {
          new QRCode(qrEl, { text: url, width: 180, height: 180 });
        } catch (err) {
          qrEl.textContent = 'QR generation failed.';
        }
        meta.innerHTML = '<div><strong>Share URL:</strong> <a id="shareLinkDisplay" href="'+url+'" target="_blank">'+url+'</a></div>';
      });

      document.getElementById('copyLink').addEventListener('click', function() {
        const url = getEffectiveShareUrl();
        if (!url) return;
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(url).then(function() {
            alert('Link copied to clipboard');
          });
        } else {
          const ta = document.createElement('textarea');
          ta.value = url;
          document.body.appendChild(ta);
          ta.select();
          document.execCommand('copy');
          document.body.removeChild(ta);
          alert('Link copied to clipboard');
        }
      });
    });

    function renderTable(entries) {
      const list = Array.isArray(entries) ? entries : dataEntries;
      const tbody = document.querySelector('#dataTable tbody');
      tbody.innerHTML = '';
      list.forEach(entry => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${entry['Master'] || ''}</td>
          <td>${entry['Employment Status'] || ''}</td>
          <td>${entry['Emp code'] || ''}</td>
          <td>${entry['Name'] || ''}</td>
          <td>${entry['Designation'] || ''}</td>
          <td>${entry['Department'] || ''}</td>
          <td>${entry['SMU(internal use)'] || ''}</td>
          <td>${entry['BU'] || ''}</td>
          <td>${entry['Gender'] || ''}</td>
          <td>${entry['Work Shift'] || ''}</td>
          <td>${entry['HR Advisor'] || ''}</td>
          <td>${entry['New HR Advisor'] || ''}</td>
          <td>${entry['Location'] || ''}</td>
        `;
        tbody.appendChild(row);
      });
    }

    renderTable();
   
    document.getElementById('tableSearch').addEventListener('input', function(e) {
      const q = (e.target.value || '').toLowerCase().trim();
      if (!q) { renderTable(); return; }
      const filtered = dataEntries.filter(d => {
        return Object.values(d).some(v => String(v).toLowerCase().includes(q));
      });
      renderTable(filtered);
    });

    document.getElementById('clearData').addEventListener('click', function() {
      if (!confirm('Clear all saved entries? This will remove data from localStorage.')) return;
      dataEntries = [];
      localStorage.removeItem('excelenceData');
      renderTable();
    });

    document.getElementById('exportCsv').addEventListener('click', function() {
      if (!dataEntries.length) { alert('No data to export'); return; }
      const keys = Object.keys(dataEntries[0]);
      const csv = [keys.join(',')].concat(dataEntries.map(r => keys.map(k => '"' + String((r[k]||'')).replace(/"/g,'""') + '"').join(','))).join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'employee-data.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    document.getElementById('excelFile').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(ev) {
        const data = new Uint8Array(ev.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        uploadedWorkbook = workbook;
        uploadedFilename = file.name || 'employee-data.xlsx';

        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(firstSheet, {defval: ''});

        dataEntries = jsonData;
        localStorage.setItem('excelenceData', JSON.stringify(dataEntries));
        renderTable();
      };
      reader.readAsArrayBuffer(file);
    });

    document.getElementById('dataForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const entry = {
        'Master': document.getElementById('Master').value,
        'Employment Status': document.getElementById('Employment Status').value,
        'Emp code': document.getElementById('Emp code').value,
        'Name': document.getElementById('Name').value,
        'Designation': document.getElementById('Designation').value,
        'Department': document.getElementById('Department').value,
        'SMU(internal use)': document.getElementById('SMU(internal use)').value,
        'BU': document.getElementById('BU').value,
        'Gender': document.getElementById('Gender').value,
        'Work Shift': document.getElementById('Work Shift').value,
        'HR Advisor': document.getElementById('HR Advisor').value,
        'New HR Advisor': document.getElementById('New HR Advisor').value,
        'Location': document.getElementById('Location').value
      };

      dataEntries.push(entry);
      localStorage.setItem('excelenceData', JSON.stringify(dataEntries));
      renderTable();
      this.reset();
    });

    document.getElementById('saveExcel').addEventListener('click', function() {
      const saveButton = this;
      saveButton.disabled = true;
      saveButton.innerHTML = '<span class="loading"></span>Saving...';

      function downloadNameFrom(original) {
        if (!original) return 'employee-data-updated.xlsx';
        return original.replace(/(\.xlsx|\.xls)$/i, '-updated$1');
      }

      if (uploadedWorkbook && uploadedWorkbook.SheetNames && uploadedWorkbook.SheetNames.length) {
        const sheetName = uploadedWorkbook.SheetNames[0];
        const ws = uploadedWorkbook.Sheets[sheetName];
       
        let range = ws && ws['!ref'] ? XLSX.utils.decode_range(ws['!ref']) : null;

        let headers = [];
        let headerRowIndex = 0;
        if (range) {
          headerRowIndex = range.s.r;
          for (let c = range.s.c; c <= range.e.c; ++c) {
            const addr = XLSX.utils.encode_cell({ r: headerRowIndex, c: c });
            const cell = ws[addr];
            headers.push(cell ? String(cell.v) : '');
          }
        } else if (dataEntries.length) {

          headers = Object.keys(dataEntries[0]);
        }

        const existingDataRowCount = range ? (range.e.r - headerRowIndex) : 0;

        const newRows = dataEntries.slice(existingDataRowCount);

        const startRow = range ? (range.e.r + 1) : (headers.length ? 1 : 0);

        for (let i = 0; i < newRows.length; ++i) {
          const rowObj = newRows[i];
          const r = startRow + i;
          for (let c = 0; c < headers.length; ++c) {
            const key = headers[c];
            const value = rowObj[key] != null ? rowObj[key] : '';
            const addr = XLSX.utils.encode_cell({ r: r, c: c });

            const cell = { v: value };
            if (typeof value === 'number') cell.t = 'n'; else cell.t = 's';
            ws[addr] = cell;
          }
        }


        const lastRow = startRow + Math.max(0, newRows.length) - 1;
        if (lastRow >= 0) {
          const endCol = headers.length ? (headers.length - 1) : (range ? range.e.c : 0);
          ws['!ref'] = XLSX.utils.encode_range({ s: { r: headerRowIndex, c: 0 }, e: { r: lastRow, c: endCol } });
        }

        const downloadName = downloadNameFrom(uploadedFilename);
        try {
          XLSX.writeFile(uploadedWorkbook, downloadName, { bookType: 'xlsx', cellStyles: true });
          alert('Appended new rows and downloaded updated workbook as "' + downloadName + '". Replace the original file manually if desired.');
          saveButton.disabled = false;
          saveButton.innerHTML = 'Save to Excel';
        } catch (err) {
 
          const merged = [].concat(dataEntries);
          const newWs = XLSX.utils.json_to_sheet(merged);
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, newWs, sheetName || 'Employees');
          XLSX.writeFile(wb, downloadName || 'employee-data-updated.xlsx', { bookType: 'xlsx', cellStyles: true });
          alert('Downloaded merged workbook as "' + (downloadName || 'employee-data-updated.xlsx') + '".');
          saveButton.disabled = false;
          saveButton.innerHTML = 'Save to Excel';
        }

      } else {
       
        const ws = XLSX.utils.json_to_sheet(dataEntries);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Employees');
        const downloadName = 'employee-data.xlsx';
          XLSX.writeFile(wb, downloadName, { bookType: 'xlsx', cellStyles: true });
          alert('Excel exported as "' + downloadName + '".');
          saveButton.disabled = false;
          saveButton.innerHTML = 'Save to Excel';
      }
    });
  </script>
  </div>
</div>
</body>
</html>
